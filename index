<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EV Charge Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: #f4f5f7;
      color: #222;
      transition: background 0.25s, color 0.25s;
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
      padding: 16px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .top-bar h1 {
      font-size: 22px;
      margin: 0;
    }

    .theme-btn {
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid #d0d4dc;
      background: #ffffff;
      font-size: 13px;
      cursor: pointer;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      margin-bottom: 12px;
      transition: background 0.25s, box-shadow 0.25s;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .form-row label {
      font-size: 12px;
      display: block;
      margin-bottom: 2px;
    }

    .form-row input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d0d4dc;
      font-size: 14px;
      background: #fff;
      color: #222;
      transition: background 0.25s, color 0.25s, border-color 0.25s;
    }

    .btn-primary {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: none;
      background: #0f9d58;
      color: #fff;
      font-weight: 600;
      font-size: 15px;
      margin-top: 4px;
      cursor: pointer;
    }

    .btn-secondary {
      width: 100%;
      padding: 8px;
      border-radius: 999px;
      border: none;
      background: #e3e6ee;
      color: #333;
      font-size: 14px;
      margin-top: 6px;
      display: none;
      cursor: pointer;
    }

    .btn-primary:active,
    .btn-secondary:active {
      opacity: 0.85;
    }

    .summary {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 14px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .summary-box {
      flex: 1 1 150px;
      background: #fff8d5;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 600;
      transition: background 0.25s, color 0.25s;
    }

    .summary-box span {
      display: block;
      font-size: 11px;
      color: #777;
      font-weight: 500;
    }

    .summary-box.blue {
      background: #dff7ff;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
      min-width: 560px;
    }

    th,
    td {
      padding: 6px 4px;
      border-bottom: 1px solid #e3e6ee;
      text-align: right;
      white-space: nowrap;
      transition: background 0.25s, color 0.25s, border-color 0.25s;
    }

    th:nth-child(1),
    td:nth-child(1),
    th:nth-child(4),
    td:nth-child(4),
    th:nth-child(8),
    td:nth-child(8) {
      text-align: left;
    }

    th {
      background: #f0f2f7;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .empty {
      text-align: center;
      padding: 10px 0;
      font-size: 12px;
      color: #888;
    }

    .monthly-list {
      font-size: 13px;
    }

    .month-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
      transition: border-color 0.25s;
    }

    .month-row:last-child {
      border-bottom: none;
    }

    .month-label {
      color: #555;
    }

    .month-value {
      font-weight: 600;
    }

    .icon-btn {
      background: transparent;
      border: none;
      padding: 2px;
      cursor: pointer;
      margin-right: 4px;
    }

    .icon-btn img {
      width: 17px;
      height: 17px;
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .icon-btn:active img {
      opacity: 1;
    }

    /* 让白色图标在浅色模式下变深一点 */
    body:not(.dark) .icon-btn img.edit-icon {
      filter: invert(0%) brightness(20%);
    }

    @media (min-width: 768px) {
      body {
        background: #e3e6ee;
      }
      .app {
        margin-top: 24px;
        margin-bottom: 24px;
        max-width: 900px;
      }
      .top-bar h1 {
        font-size: 24px;
      }
      table {
        font-size: 13px;
      }
    }

    /* Dark mode */
    body.dark {
      background: #111111;
      color: #f5f5f5;
    }

    body.dark .card {
      background: #1c1c1e;
      box-shadow: none;
    }

    body.dark .form-row input {
      background: #2c2c2e;
      border-color: #444;
      color: #f5f5f5;
    }

    body.dark .summary-box {
      background: #2c2c2e;
      color: #f5f5f5;
    }

    body.dark .summary-box span {
      color: #b0b0b0;
    }

    body.dark .summary-box.blue {
      background: #123347;
    }

    body.dark table {
      background: #1c1c1e;
    }

    body.dark th {
      background: #2c2c2e;
    }

    body.dark th,
    body.dark td {
      border-bottom-color: #333;
    }

    body.dark .month-row {
      border-bottom-color: #333;
    }

    body.dark .empty {
      color: #aaaaaa;
    }

    body.dark .theme-btn {
      background: #2c2c2e;
      border-color: #555;
      color: #f5f5f5;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top-bar">
      <h1>EV Charge Log</h1>
      <button id="theme-toggle" class="theme-btn">☾ Dark</button>
    </div>

    <!-- Form -->
    <div class="card">
      <div class="form-row">
        <div style="flex:1.1 1 140px">
          <label>Date</label>
          <input id="date" type="date" />
        </div>
        <div style="flex:0.9 1 90px">
          <label>Start %</label>
          <input id="start" type="number" />
        </div>
        <div style="flex:0.9 1 90px">
          <label>End %</label>
          <input id="end" type="number" />
        </div>
      </div>

      <div class="form-row">
        <div style="flex:1.1 1 160px">
          <label>Location</label>
          <input id="location" type="text" placeholder="BH / PV / Bamboo…" />
        </div>
        <div style="flex:0.9 1 110px">
          <label>Rate (RM/kWh)</label>
          <input id="rate" type="number" step="0.01" />
        </div>
        <div style="flex:0.9 1 110px">
          <label>Cost (RM)</label>
          <input id="cost" type="number" step="0.01" />
        </div>
      </div>

      <button class="btn-primary" id="submit-btn">Add Record</button>
      <button class="btn-secondary" id="cancel-btn">Cancel Edit</button>
    </div>

    <!-- Summary -->
    <div class="summary">
      <div class="summary-box" id="total-cost-box">
        RM0.00
        <span>Total Cost</span>
      </div>
      <div class="summary-box blue" id="total-kwh-box">
        0.00 kWh
        <span>Total Charged</span>
      </div>
    </div>

    <!-- Monthly Summary -->
    <div class="card">
      <div style="font-size:14px;font-weight:600;margin-bottom:4px;">Monthly Total (RM)</div>
      <div id="monthly-summary" class="monthly-list">
        <div class="empty">No data yet</div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Start%</th>
              <th>End%</th>
              <th>Location</th>
              <th>Rate</th>
              <th>Cost</th>
              <th>Charged</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
      <div class="empty" id="empty-row">No data yet</div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "ev_charge_log_data";
    const THEME_KEY = "ev_charge_theme";

    let records = [];
    let editingIndex = null;

    const dateInput = document.getElementById("date");
    const startInput = document.getElementById("start");
    const endInput = document.getElementById("end");
    const locationInput = document.getElementById("location");
    const rateInput = document.getElementById("rate");
    const costInput = document.getElementById("cost");

    const submitBtn = document.getElementById("submit-btn");
    const cancelBtn = document.getElementById("cancel-btn");
    const themeBtn = document.getElementById("theme-toggle");

    function load() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          records = JSON.parse(raw) || [];
        } catch {
          records = [];
        }
      }
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    function applyTheme(theme) {
      if (theme === "dark") {
        document.body.classList.add("dark");
        themeBtn.textContent = "☀ Light";
      } else {
        document.body.classList.remove("dark");
        themeBtn.textContent = "☾ Dark";
      }
    }

    function loadTheme() {
      const saved = localStorage.getItem(THEME_KEY) || "light";
      applyTheme(saved);
    }

    themeBtn.addEventListener("click", () => {
      const newTheme = document.body.classList.contains("dark") ? "light" : "dark";
      localStorage.setItem(THEME_KEY, newTheme);
      applyTheme(newTheme);
    });

    function setAddMode() {
      editingIndex = null;
      submitBtn.textContent = "Add Record";
      cancelBtn.style.display = "none";
      // 预填今天日期（如果原本是空）
      if (!dateInput.value) {
        const today = new Date();
        dateInput.value = today.toISOString().slice(0, 10);
      }
      startInput.value = "";
      endInput.value = "";
      locationInput.value = "";
      rateInput.value = "";
      costInput.value = "";
    }

    function setEditMode(i) {
      const r = records[i];
      editingIndex = i;
      dateInput.value = r.date;
      startInput.value = r.start;
      endInput.value = r.end;
      locationInput.value = r.location;
      rateInput.value = r.rate;
      costInput.value = r.cost;

      submitBtn.textContent = "Save Changes";
      cancelBtn.style.display = "block";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function deleteRecord(i) {
      if (!confirm("Delete this record?")) return;
      records.splice(i, 1);
      save();
      setAddMode();
      render();
    }

    function formatDate(d) {
      if (!d) return "";
      const dd = new Date(d);
      if (isNaN(dd)) return d;
      return dd.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "2-digit"
      });
    }

    function render() {
      const tbody = document.getElementById("table-body");
      const emptyRow = document.getElementById("empty-row");
      const monthlyDiv = document.getElementById("monthly-summary");

      tbody.innerHTML = "";
      monthlyDiv.innerHTML = "";

      if (records.length === 0) {
        emptyRow.style.display = "block";
        monthlyDiv.innerHTML = '<div class="empty">No data yet</div>';
        document.getElementById("total-cost-box").firstChild.nodeValue = "RM0.00";
        document.getElementById("total-kwh-box").firstChild.nodeValue = "0.00 kWh";
        return;
      }

      emptyRow.style.display = "none";

      let totalCost = 0;
      let totalKwh = 0;
      const monthly = {};

      // 按日期排序（旧 → 新）
      const decorated = records
        .map((r, i) => ({ ...r, _i: i }))
        .sort((a, b) => (a.date || "").localeCompare(b.date || ""));

      decorated.forEach((r) => {
        const i = r._i;
        const charged = r.rate > 0 ? r.cost / r.rate : 0;

        totalCost += r.cost;
        totalKwh += charged;

        if (r.date) {
          const key = r.date.slice(0, 7); // YYYY-MM
          monthly[key] = (monthly[key] || 0) + r.cost;
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formatDate(r.date)}</td>
          <td>${r.start}</td>
          <td>${r.end}</td>
          <td>${r.location}</td>
          <td>${r.rate.toFixed(2)}</td>
          <td>RM${r.cost.toFixed(2)}</td>
          <td>${charged.toFixed(2)}</td>
          <td></td>
        `;

        const actionCell = tr.lastElementChild;

        const editBtn = document.createElement("button");
        editBtn.className = "icon-btn";
        editBtn.innerHTML = '<img class="edit-icon" src="https://img.icons8.com/ios-filled/50/ffffff/edit.png"/>';
        editBtn.onclick = () => setEditMode(i);

        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn";
        delBtn.innerHTML = '<img src="https://img.icons8.com/ios-glyphs/30/fa314a/trash.png"/>';
        delBtn.onclick = () => deleteRecord(i);

        actionCell.appendChild(editBtn);
        actionCell.appendChild(delBtn);

        tbody.appendChild(tr);
      });

      document.getElementById("total-cost-box").firstChild.nodeValue =
        "RM" + totalCost.toFixed(2);
      document.getElementById("total-kwh-box").firstChild.nodeValue =
        totalKwh.toFixed(2) + " kWh";

      Object.keys(monthly)
        .sort()
        .forEach((key) => {
          const div = document.createElement("div");
          div.className = "month-row";
          div.innerHTML = `
            <div class="month-label">${key.slice(5)}/${key.slice(0, 4)}</div>
            <div class="month-value">RM${monthly[key].toFixed(2)}</div>
          `;
          monthlyDiv.appendChild(div);
        });
    }

    function submit() {
      const r = {
        date: dateInput.value,
        start: Number(startInput.value),
        end: Number(endInput.value),
        location: locationInput.value.trim(),
        rate: Number(rateInput.value),
        cost: Number(costInput.value),
      };

      if (!r.date || !r.rate || !r.cost) {
        alert("Date, Rate, Cost cannot be empty.");
        return;
      }

      if (editingIndex === null) {
        records.push(r);
      } else {
        records[editingIndex] = r;
      }

      save();
      setAddMode();
      render();
    }

    submitBtn.onclick = submit;
    cancelBtn.onclick = setAddMode;

    load();
    loadTheme();
    setAddMode();
    render();
  </script>
</body>
</html>

