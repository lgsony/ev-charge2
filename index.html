<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EV Charge Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: #f4f5f7;
      color: #222;
      transition: background 0.25s, color 0.25s;
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Top bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .top-bar h1 {
      margin: 0;
      font-size: 22px;
    }
    .theme-btn {
      padding: 4px 12px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 13px;
    }

    /* Card */
    .card {
      background: #fff;
      padding: 14px;
      border-radius: 12px;
      margin-top: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    /* Form */
    .form-group {
      margin-bottom: 10px;
    }
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .form-group label,
    .form-row label {
      font-size: 12px;
      display: block;
      margin-bottom: 2px;
    }
    .input-base {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 15px;
      -webkit-appearance: none;
      appearance: none;
      height: 42px;
    }
    input[type="date"]::-webkit-date-and-time-value {
      padding-left: 4px;
    }

    .btn-primary {
      width: 100%;
      margin-top: 5px;
      padding: 10px;
      font-size: 15px;
      color: #fff;
      background: #0f9d58;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
    .btn-secondary {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      background: #ddd;
      border-radius: 999px;
      border: none;
      display: none;
      cursor: pointer;
    }

    /* Backup buttons */
    .backup-btn {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      margin-top: 4px;
    }
    .backup-btn.primary {
      background: #0f9d58;
      color: #fff;
    }
    .backup-btn.secondary {
      background: #e3e6ee;
      color: #222;
    }

    /* Summary */
    .summary {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .summary-box {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      background: #fff8d5;
      font-weight: 600;
      text-align: center;
      font-size: 14px;
    }
    .summary-box span {
      display: block;
      font-size: 11px;
      color: #666;
      font-weight: 500;
    }
    .summary-box.blue {
      background: #dff7ff;
    }

    /* Monthly list */
    .month-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #e0e0e0;
      font-size: 13px;
    }
    .month-row:last-child {
      border-bottom: none;
    }

    /* Excel-style table */
    .table-wrapper {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      min-width: 600px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #d0d4dc;
      padding: 8px 10px;
      white-space: nowrap;
      text-align: center !important; /* 全部居中 */
    }
    th {
      background: #f2f4f7;
      font-weight: 600;
    }

    .empty {
      text-align: center;
      font-size: 13px;
      color: #777;
      padding: 10px 0;
    }

    /* Action icons */
    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
    }
    .icon-btn img {
      width: 18px;
      height: 18px;
      opacity: 0.9;
    }

    /* Dark mode */
    body.dark {
      background: #111;
      color: #f5f5f5;
    }
    body.dark .card {
      background: #1c1c1e;
      box-shadow: none;
    }
    body.dark .input-base {
      background: #2c2c2e;
      border-color: #444;
      color: #fff;
    }
    body.dark .summary-box {
      background: #2c2c2e;
      color: #fff;
    }
    body.dark .summary-box span {
      color: #bbb;
    }
    body.dark .summary-box.blue {
      background: #123347;
    }
    body.dark table th,
    body.dark table td {
      border-color: #333;
    }
    body.dark table th {
      background: #2c2c2e;
    }
    body.dark .month-row {
      border-bottom-color: #333;
    }
    body.dark .theme-btn {
      background: #2c2c2e;
      border-color: #555;
      color: #fff;
    }
    body.dark .backup-btn.secondary {
      background: #2c2c2e;
      color: #f5f5f5;
    }

    @media (min-width: 768px) {
      body { background: #e3e6ee; }
      .app { max-width: 900px; margin-top: 24px; margin-bottom: 24px; }
      .top-bar h1 { font-size: 24px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top-bar">
      <h1>EV Charge Log</h1>
      <button id="theme-toggle" class="theme-btn">☾ Dark</button>
    </div>

    <!-- FORM -->
    <div class="card">
      <div class="form-group">
        <label>Date</label>
        <input id="date" type="date" class="input-base">
      </div>

      <div class="form-row">
        <div style="flex:1">
          <label>Start %</label>
          <input id="start" type="number" inputmode="numeric" pattern="[0-9]*" class="input-base">
        </div>
        <div style="flex:1">
          <label>End %</label>
          <input id="end" type="number" inputmode="numeric" pattern="[0-9]*" class="input-base">
        </div>
      </div>

      <div class="form-group">
        <label>Location</label>
        <input id="location" type="text" class="input-base" placeholder="BH / PV / BAMBOO HILL">
      </div>

      <div class="form-row">
        <div style="flex:1">
          <label>Rate (RM/kWh)</label>
          <input id="rate" type="number" inputmode="decimal" step="0.01" class="input-base">
        </div>
        <div style="flex:1">
          <label>Cost (RM)</label>
          <input id="cost" type="number" inputmode="decimal" step="0.01" class="input-base">
        </div>
      </div>

      <button id="submit-btn" class="btn-primary">Add Record</button>
      <button id="cancel-btn" class="btn-secondary">Cancel Edit</button>
    </div>

    <!-- SUMMARY -->
    <div class="summary">
      <div id="total-cost-box" class="summary-box">
        RM0.00
        <span>Total Cost</span>
      </div>
      <div id="total-kwh-box" class="summary-box blue">
        0.00 kWh
        <span>Total Charged</span>
      </div>
    </div>

    <!-- MONTHLY -->
    <div class="card">
      <div style="font-size:14px;font-weight:600;margin-bottom:6px;">Monthly Total (RM)</div>
      <div id="monthly-summary">
        <div class="empty">No data yet</div>
      </div>
    </div>

    <!-- BACKUP -->
    <div class="card">
      <div style="font-size:14px;font-weight:600;margin-bottom:4px;">Backup</div>
      <button id="export-btn" class="backup-btn primary">Export CSV</button>
      <button id="import-btn" class="backup-btn secondary">Import CSV</button>
      <input id="csv-input" type="file" accept=".csv,text/csv" style="display:none">
      <div style="font-size:11px;color:#777;margin-top:6px;">
        Tip: export CSV before big changes / new version. Use Import to restore.
      </div>
    </div>

    <!-- TABLE -->
    <div class="card">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Start%</th>
              <th>End%</th>
              <th>Location</th>
              <th>Rate</th>
              <th>Cost</th>
              <th>Charged</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
      <div id="empty-row" class="empty">No data yet</div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "ev_charge_log_v4";
    const THEME_KEY   = "ev_theme_v4";

    let records = [];
    let editingIndex = null;

    const dateInput     = document.getElementById("date");
    const startInput    = document.getElementById("start");
    const endInput      = document.getElementById("end");
    const locationInput = document.getElementById("location");
    const rateInput     = document.getElementById("rate");
    const costInput     = document.getElementById("cost");

    const submitBtn = document.getElementById("submit-btn");
    const cancelBtn = document.getElementById("cancel-btn");
    const themeBtn  = document.getElementById("theme-toggle");

    const exportBtn = document.getElementById("export-btn");
    const importBtn = document.getElementById("import-btn");
    const csvInput  = document.getElementById("csv-input");

    /* LOCATION 自动大写 */
    locationInput.addEventListener("input", () => {
      locationInput.value = locationInput.value.toUpperCase();
    });

    /* 日期显示：5/12/2025 */
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      const day = d.getDate();
      const month = d.getMonth() + 1;
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    /* 把各种日期格式变成 ISO (YYYY-MM-DD) */
    function toISODate(str) {
      if (!str) return "";
      str = str.trim();
      if (!str) return "";

      if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(str)) {
        return str; // already ISO-like
      }

      let m;
      if (m = /^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/.exec(str)) {
        let d  = parseInt(m[1], 10);
        let mo = parseInt(m[2], 10);
        let y  = parseInt(m[3], 10);
        if (y < 100) y += 2000;
        const dt = new Date(y, mo - 1, d);
        if (!isNaN(dt)) return dt.toISOString().slice(0,10);
      }

      const dt = new Date(str);
      if (!isNaN(dt)) return dt.toISOString().slice(0,10);
      return "";
    }

    /* 读写本地数据 */
    function load() {
      try {
        records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch {
        records = [];
      }
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    /* 主题 */
    function applyTheme(theme) {
      if (theme === "dark") {
        document.body.classList.add("dark");
        themeBtn.textContent = "☀ Light";
      } else {
        document.body.classList.remove("dark");
        themeBtn.textContent = "☾ Dark";
      }
    }

    function loadTheme() {
      const t = localStorage.getItem(THEME_KEY) || "light";
      applyTheme(t);
    }

    themeBtn.addEventListener("click", () => {
      const newTheme = document.body.classList.contains("dark") ? "light" : "dark";
      localStorage.setItem(THEME_KEY, newTheme);
      applyTheme(newTheme);
    });

    /* 表单模式 */
    function setAddMode() {
      editingIndex = null;
      submitBtn.textContent = "Add Record";
      cancelBtn.style.display = "none";

      if (!dateInput.value) {
        const today = new Date();
        dateInput.value = today.toISOString().slice(0, 10);
      }
      startInput.value = "";
      endInput.value = "";
      locationInput.value = "";
      rateInput.value = "";
      costInput.value = "";
    }

    function setEditMode(i) {
      const r = records[i];
      editingIndex = i;

      dateInput.value     = r.date;
      startInput.value    = r.start;
      endInput.value      = r.end;
      locationInput.value = r.location;
      rateInput.value     = r.rate;
      costInput.value     = r.cost;

      submitBtn.textContent = "Save Changes";
      cancelBtn.style.display = "block";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function deleteRecord(i) {
      if (!confirm("Delete this record?")) return;
      records.splice(i, 1);
      save();
      setAddMode();
      render();
    }

    /* 渲染 */
    function render() {
      const tbody       = document.getElementById("table-body");
      const emptyRow    = document.getElementById("empty-row");
      const monthlyDiv  = document.getElementById("monthly-summary");
      const totalCostEl = document.getElementById("total-cost-box");
      const totalKwhEl  = document.getElementById("total-kwh-box");

      tbody.innerHTML = "";
      monthlyDiv.innerHTML = "";

      if (records.length === 0) {
        emptyRow.style.display = "block";
        monthlyDiv.innerHTML = '<div class="empty">No data yet</div>';
        totalCostEl.firstChild.nodeValue = "RM0.00";
        totalKwhEl.firstChild.nodeValue  = "0.00 kWh";
        return;
      }

      emptyRow.style.display = "none";

      let totalCost = 0;
      let totalKwh  = 0;
      const monthly = {};

      const decorated = records
        .map((r, i) => ({ ...r, _i: i }))
        .sort((a, b) => (a.date || "").localeCompare(b.date || ""));

      decorated.forEach(r => {
        const idx = r._i;
        const charged = r.rate > 0 ? r.cost / r.rate : 0;

        totalCost += r.cost;
        totalKwh  += charged;

        if (r.date) {
          const key = r.date.slice(0, 7); // YYYY-MM
          monthly[key] = (monthly[key] || 0) + r.cost;
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formatDate(r.date)}</td>
          <td>${r.start}</td>
          <td>${r.end}</td>
          <td>${r.location}</td>
          <td>${r.rate.toFixed(2)}</td>
          <td>RM${r.cost.toFixed(2)}</td>
          <td>${charged.toFixed(2)}</td>
          <td></td>
        `;

        const actionCell = tr.lastElementChild;

        const editBtn = document.createElement("button");
        editBtn.className = "icon-btn";
        editBtn.innerHTML =
          '<img src="https://img.icons8.com/ios-filled/50/ffffff/edit.png">';
        editBtn.onclick = () => setEditMode(idx);

        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn";
        delBtn.innerHTML =
          '<img src="https://img.icons8.com/ios-glyphs/30/fa314a/trash.png">';
        delBtn.onclick = () => deleteRecord(idx);

        actionCell.appendChild(editBtn);
        actionCell.appendChild(delBtn);

        tbody.appendChild(tr);
      });

      totalCostEl.firstChild.nodeValue = "RM" + totalCost.toFixed(2);
      totalKwhEl.firstChild.nodeValue  = totalKwh.toFixed(2) + " kWh";

      /* Monthly summary：DEC 2025 */
      const monthNames = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];

      Object.keys(monthly)
        .sort()
        .forEach(key => {
          const year = key.slice(0, 4);
          const mIdx = Number(key.slice(5)) - 1;
          const label = monthNames[mIdx] + " " + year;

          const row = document.createElement("div");
          row.className = "month-row";
          row.innerHTML = `
            <div>${label}</div>
            <div><strong>RM${monthly[key].toFixed(2)}</strong></div>
          `;
          monthlyDiv.appendChild(row);
        });
    }

    /* 提交 */
    function submit() {
      const r = {
        date: toISODate(dateInput.value),
        start: Number(startInput.value),
        end: Number(endInput.value),
        location: locationInput.value.trim(),
        rate: Number(rateInput.value),
        cost: Number(costInput.value)
      };

      if (!r.date || !r.rate || !r.cost) {
        alert("Date, Rate, Cost cannot be empty.");
        return;
      }

      if (editingIndex === null) {
        records.push(r);
      } else {
        records[editingIndex] = r;
      }

      save();
      setAddMode();
      render();
    }

    submitBtn.addEventListener("click", submit);
    cancelBtn.addEventListener("click", setAddMode);

    /* ---------- CSV EXPORT / IMPORT ---------- */

    function exportCSV() {
      if (!records.length) {
        alert("No data to export.");
        return;
      }
      const lines = ["date,start,end,location,rate,cost"];
      records.forEach(r => {
        const loc = (r.location || "").replace(/"/g, '""');
        const line =
          `${r.date || ""},${r.start},${r.end},"${loc}",${r.rate},${r.cost}`;
        lines.push(line);
      });
      const csv = lines.join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const now = new Date();
      const stamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}`;
      a.href = url;
      a.download = `ev_charge_log_${stamp}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function parseCSV(text) {
      const rows = text.split(/\r?\n/).filter(l => l.trim());
      if (!rows.length) return [];

      // 简单 CSV 分割（支持基本引号）
      const splitRow = (row) => {
        const result = [];
        let current = "";
        let inQuotes = false;
        for (let i = 0; i < row.length; i++) {
          const c = row[i];
          if (c === '"') {
            inQuotes = !inQuotes;
            continue;
          }
          if (c === "," && !inQuotes) {
            result.push(current);
            current = "";
          } else {
            current += c;
          }
        }
        result.push(current);
        return result.map(s => s.trim());
      };

      const headerCols = splitRow(rows[0]);
      let hasHeader =
        headerCols.some(h => /date/i.test(h));

      let startIndex = hasHeader ? 1 : 0;

      let map;
      if (hasHeader) {
        const hmap = {};
        headerCols.forEach((h, i) => {
          hmap[h.toLowerCase()] = i;
        });
        map = {
          date: hmap["date"],
          start: hmap["start"] ?? hmap["start%"],
          end: hmap["end"] ?? hmap["end%"],
          location: hmap["location"],
          rate: hmap["rate"],
          cost: hmap["cost"]
        };
      } else {
        map = { date: 0, start: 1, end: 2, location: 3, rate: 4, cost: 5 };
      }

      const out = [];
      for (let i = startIndex; i < rows.length; i++) {
        const cols = splitRow(rows[i]);
        if (!cols.length) continue;

        const get = (idx) => (idx != null && cols[idx] != null ? cols[idx] : "").trim();

        const date = toISODate(get(map.date));
        const rate = Number(get(map.rate));
        const cost = Number(get(map.cost));
        const start = Number(get(map.start));
        const end = Number(get(map.end));
        const loc = get(map.location).replace(/""/g, '"');

        if (!date && !rate && !cost) continue; // skip garbage row

        out.push({
          date,
          start: isNaN(start) ? 0 : start,
          end: isNaN(end) ? 0 : end,
          location: loc.toUpperCase(),
          rate: isNaN(rate) ? 0 : rate,
          cost: isNaN(cost) ? 0 : cost
        });
      }
      return out;
    }

    function handleImportCSV(text) {
      const parsed = parseCSV(text);
      if (!parsed.length) {
        alert("No valid rows in CSV.");
        return;
      }
      const replace = confirm(
        "Imported " + parsed.length + " rows.\n\nOK = REPLACE current data\nCancel = APPEND to current data"
      );
      if (replace) {
        records = parsed;
      } else {
        records = records.concat(parsed);
      }
      save();
      setAddMode();
      render();
    }

    exportBtn.addEventListener("click", exportCSV);

    importBtn.addEventListener("click", () => {
      csvInput.value = "";
      csvInput.click();
    });

    csvInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        handleImportCSV(ev.target.result || "");
      };
      reader.readAsText(file);
    });

    /* INIT */
    load();
    loadTheme();
    setAddMode();
    render();
  </script>
</body>
</html>
